Chapter04 設計網路限速器
=====
* ### Rate Limiter 用於控制與限制指定時間內客戶端或服務端流量速度。
* ### Rate Limiter 可以是單獨服務或撰寫於程式碼中 (可以放在伺服器也可以是獨立的微服務)。
* ### 使用 API Rate Limiter 好處:
    * ### 避免 DDos。
    * ### 降低第三方應用成本。
    * ### 防止伺服器超載。
* ### Rate Limiter 需求:
    * ### 限制過多需求。
    * ### 低延遲，不應影響 HTTP 回應時間。
    * ### 不要使用太多記憶體。
    * ### 分散式網路限速 (伺服器或行程可以共用同一個限速器)。
    * ### 具備異常處理 (向使用者顯示明確通知)。
    * ### 高容錯，不可影響整個系統。
* ### Rate Limiter 通常實作於伺服器端。
* ### HTTP Status 429: Too Many Requests.
* ### 在雲端服務上，限速功能可以在 API gateway 實作。
* ### 應該要在哪裡實作網路限速器 ?
    * ### 程式語言是否適合。
    * ### 對於限速器的控制與受限程度。
    * ### 是否已使用雲端架構。
    * ### 成本時間考量。
* ### 網路限速器演算法: Token bucket, Leaking bucket, Fixed window counter, Sliding window log, Sliding window counter.
* ### Token bucket: 需要預設桶子容量，並以定期預設速度放入 token 至桶中，每一個請求都會消耗一個 token，若桶內沒有 token 則丟棄請求。
    * ### 桶子的數量可以依 API、IP 或伺服器個體決定。
    * ### 優點: 實作容易、低記憶體消耗、可接受爆炸流量。
    * ### 難點: 桶子大小與 Token 填入速度設定。
* ### Leaking bucket: 採用先進先出，佇列未滿請求加入，佇列已滿丟棄請求，並以固定間隔時間拉出請求進行處理，需定義桶子大小與流出速度。
    * ### 優點: 低記憶體消耗、適用於穩定流出場景。
    * ### 缺點: 無法處理爆炸流量、參數調整不易。
* ### Fixed window counter: 將時間軸劃分成固定大小視窗，並指定一個計數器給它使用，當計數器達門檻值就不再接受請求，直到下一個時間視窗為止。
    * ### 優點: 低記憶體消耗、容易理解、適用於單位時間重設請求配額場景。
    * ### 缺點: 視窗切換時若有爆炸流量可能導致系統通過請求超過允許配額。
* ### Sliding window log: 追蹤請求時間戳 (Unix Timestamp)，通常存於快取 (Redis)，當有新請求時進行時間戳過時刪除，當請求超過可接受數量，該請求時間戳一樣會被記錄，但請求會被拒絕。
    * ### 優點: 限速效果準確。
    * ### 缺點: 相比會使用較多記憶體資源，因被拒絕之請求的時間戳一樣會被記錄。
* ### Sliding window counter: 假設每分鐘可接受 7 個請求，而前一分鐘有 5 個請求，當前這一分鐘有 3 個請求 (假設位於前 30 %，也就是前 18 秒)，透過公式計算，3 + 5 * 0.7 = 6.5，尚未超過每分鐘 7 個請求限制，故該請求將被接受。
    * ### 優點: 可以減緩突然出現流量高峰問題、低記憶體消耗。
    * ### 缺點: 有很低的機率因請求在時間上分佈不均而造成請求被錯誤接受 (約 0.003 %)。
* ### 透過 Redis 儲存系統，使用 INCR 與 EXPIRE 操作，判斷請求應轉送或是拒絕。
* ### 超出限速限制的請求，除了要回傳 429，也須依場景決定請求應丟棄或放入佇列稍後處理。
* ### 網路限速 HTTP 回應標頭
    * ### X-Ratelimit-Remaining: 在目前視窗內可接受請求次數。
    * ### X-Ratelimit-Limit: 每個視窗內可接受請求次數。
    * ### X-Ratelimit-Retry-After: 還需等待多久才能解除限制在次方送請求。
* ### 未超出速率限制時
    * ### 處理請求
    * ### X-RateLimit-Limit: 每個間隔容許的呼叫數。
    * ### X-RateLimit-Remaining: 達到限制之前的間隔中剩餘呼叫數。
* ### 已超出速率限制時
    * ### 拒絕請求
    * ### HTTP Status Code: 429
    * ### X-RateLimit-Reset: 下一個間隔開始之前剩餘的秒數。
    * ### Retry-After: 與 X-RateLimit-Reset 相同。
* ### 分散式環境下網路限速器問題
    * ### 競爭: 透過 Lock、Lua 腳本或 Redis 的已排序集合資料結構解決。
    * ### 同步: 使用 Redis 集中式資料儲存系統。
    * ### 效能: 使用邊緣 (edge) 伺服器降低因地理原因造成延遲與運用終究一致性 (eventual consistency) 同步資料。
* ### 監控: 限速器算法效率、限速器規則效率。
* ### 硬性限制 (請求絕不可超過門檻) 與軟性限制 (請求可在短時間內超過門檻)。
* ### ![image](https://raw.githubusercontent.com/GitHub-WeiChiang/main/master/SystemsDesign/Chapter04/SystemArchitectureDiagram.png)
<br />
