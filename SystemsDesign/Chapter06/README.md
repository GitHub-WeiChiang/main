Chapter06 設計鍵值儲存系統
=====
* ### 單一伺服器
    * ### 資料壓縮。
    * ### 常用放記憶體，其餘放磁碟。
* ### CAP 定理
    * ### 一致性 (Consistency)
    * ### 可用性 (Availability)
    * ### 分區容錯能力 (Partition Tolerance)
* ### 系統分類
    * ### CP 系統: 支援一致性與分區容錯。
    * ### AP 系統: 支援可用性與分區容錯。
    * ### CA 系統: 支援一致性與可用性，但不支援分區容錯，實際應用通常不採用此方案。
* ### 現實中必須在一致性與可用性之間抉擇。
* ### 假設一個分散式系統有三台伺服器互聯，其中一台離線了。
    * ### CP 系統會阻止寫入操作確保一致性。
    * ### AP 系統可以正常操作待設備恢復再進行資料同步。
* ### 資料區分: 透過一致性的雜湊達成。
* ### 資料複製: 設定變數 N 為需複製至的伺服器數量，在雜湊環上順時針儲存至 N 部伺服器，若遇到虛擬節點要避開已儲存之伺服器。
* ### 一致性
    * ### 最低門檻共識 (Quorum Consensus): 設定 N (副本數量)、W (必須成功寫入 N 台伺服器中的幾台伺服器) 與 R (必須成功讀取 N 台伺服器中的幾台伺服器)。
    * ### W = 1 or R = 1，操作回應速度會很快。
    * ### W > 1 or R > 1，操作回應速度會較慢。
    * ### W + R > N，可以確保強一致性。
    * ### 讀取最佳化: R = 1 and W = N。
    * ### 寫入最佳化: W = 1 and R = N。
    * ### 強一致性: W + R > N。
    * ### 非強一致性: W + R <= N。
* ### 一致性模型
    * ### 強一致性
    * ### 弱一致性
    * ### 終究一致性 (Eventual Consistency)
* ### 不一致問題的解決: 版本控制 (Versioning)。
* ### 版本控制: 每一次的資料修改都是一個全新的版本。
* ### 偵測衝突與協調的方式: 向量時鐘 (Vector Clocks)。
* ### 向量時鐘: 與資料項相關連的一對資訊 (伺服器編號, 版本計數器)，可用於檢查版本是否為最新、成功與衝突。
* ### 向量時鐘缺點: 增加客戶端複雜度，必須實作衝突解決邏輯。
* ### 故障偵測
    * ### All-To-All 多播 (multicasting): 簡單明瞭效率差。
    * ### 去中心化: 每個節點維護一個成員心跳列表，節點會定期增加自己的心跳數值並隨機發送給一組節點，當收到來自其它節點的心跳就會更新自己維護的表，當某節點心跳值保持不變超時時，則視為離線 (offline)。
* ### 處理臨時性故障
    * ### 透過草率仲裁 (sloppy quorum) 提高可用性: 直接忽略離線伺服器，在雜湊環上選擇前 W 個可運行伺服器寫入並選擇前 R 個可運行伺服器讀取。
    * ### 以提示換手 (hinted handoff) 方式，臨時接管故障伺服器工作，待恢復後將資料推送回去。
* ### 跨資料中心架構
    * ### 與客戶溝通的點為協調者。
    * ### 協調者扮演客戶與鍵值儲存系統的中間代理 (proxy)。
    * ### 使用具有一致性的雜湊。
    * ### 每個節點職責相同。
* ### 寫入途徑
    * ### 寫入請求會存於日誌。
    * ### 資料保存於記憶體。
    * ### 記憶體滿了刷新到磁碟。
* ### 讀取途徑
    * ### 抓快取。
    * ### 快取沒有抓磁碟 (Bloom 篩選器)。
* ### Bloom Filter 是一種可以儲存「某一個元素是否存在」的集合， 我們可以用這種資料結構快速查詢像是「某隻小雞是否在這間雞舍」或「某位學生是不是在這間實驗室」這一類的資訊。
<br />
